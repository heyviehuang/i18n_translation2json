<!doctype html>
<html lang="zh-Hant">

    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>RVOCA :: CLI Mode</title>
        <style>
            body {
                margin: 0;
                background: #111;
                color: #eee;
                font-family: 'Fira Code', Consolas, 'Courier New', monospace;
                font-size: 15px;
                line-height: 1.5;
                display: flex;
                justify-content: center;
                align-items: flex-start;
                min-height: 100vh;
                padding: 2rem;
            }

            #app {
                width: 600px;
                max-width: 90vw;
                background: #111;
                border: 1px solid #333;
                padding: 1rem 1.5rem;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            }

            .muted {
                color: #666;
            }

            .zh {
                color: #9f9;
                margin-top: .3rem;
            }

            .prompt::before {
                content: "> ";
                color: #0f0;
            }

            .word {
                color: #fff;
                font-weight: 600;
                cursor: pointer;
            }

            button {
                background: none;
                border: 1px solid #444;
                color: #ccc;
                font-family: inherit;
                font-size: 13px;
                padding: .3rem .8rem;
                margin-right: .4rem;
                cursor: pointer;
            }

            button:hover {
                background: #222;
                color: #0f0;
            }

            .divider {
                border-top: 1px solid #333;
                margin: 1rem 0;
            }
        </style>
    </head>

    <body>
        <div id="app">
            <div class="prompt">RVOCA CLI initialized.</div>
            <div class="prompt">Loading next batch...</div>
            <div class="divider"></div>
            <div class="prompt"><span id="word" class="word">--</span></div>
            <div class="prompt"><span id="zh" class="zh muted">(click to reveal translation)</span></div>
            <div class="divider"></div>
            <div>
                <button id="btnReveal">reveal</button>
                <button id="btnSpeak">speak</button>
                <button id="btnWrong">wrong</button>
                <button id="btnKnown">known</button>
            </div>
            <div class="prompt muted" id="status"></div>
        </div>


        <script>
            /* === 改成你的部署資訊 === */
            const API_BASE = "https://script.google.com/macros/s/AKfycbyOv4GDW2Ns8pYfUDm1bKEPoTbYxPTS3VC8HdwLTLF8KyOpDEgqhS-XgIZ_ppDJGKo/exec";
            const TOKEN = "rvo-2025-chiuchiou";
            const ROUND_SIZE = 15;

            let batch = [];
            let index = -1;
            let showingZh = false;

            // --- 語音朗讀 ---
            function speak(text) {
                if (!('speechSynthesis' in window)) return;
                const utter = new SpeechSynthesisUtterance(text);
                utter.lang = 'en-US';
                utter.rate = 0.9;
                window.speechSynthesis.cancel(); // 避免重疊
                window.speechSynthesis.speak(utter);
            }

            // --- JSONP 取資料 ---
            function jsonp(params) {
                return new Promise((resolve, reject) => {
                    const cb = "cb_" + Math.random().toString(36).slice(2);
                    const qs = new URLSearchParams({ token: TOKEN, callback: cb, ...params });
                    const s = document.createElement("script");
                    s.src = API_BASE + "?" + qs.toString();
                    s.onerror = () => reject(new Error("JSONP load error"));
                    window[cb] = (data) => { resolve(data); s.remove(); delete window[cb]; };
                    document.body.appendChild(s);
                    setTimeout(() => reject(new Error("timeout")), 10000);
                });
            }

            // --- 顯示單字 ---
            function render() {
                if (index >= batch.length) {
                    document.getElementById("word").textContent = "本回合結束 ✔";
                    document.getElementById("zh").style.display = "none";
                    return;
                }
                const w = batch[index];
                document.getElementById("word").textContent = w.word;
                document.getElementById("zh").textContent = w.zh;
                document.getElementById("zh").style.display = showingZh ? "block" : "none";
            }

            // --- 下一題 ---
            function nextWord() {
                if (!showingZh) {
                    showingZh = true;
                    document.getElementById("zh").style.display = "block";
                } else {
                    index++;
                    showingZh = false;
                    render();
                    if (index < batch.length) speak(batch[index].word); // 自動朗讀
                }
            }

            // --- 初始化 ---
            (async () => {
                const res = await jsonp({ action: "nextBatch", count: ROUND_SIZE });
                batch = res.items || [];
                index = 0;
                render();
                speak(batch[index].word); // 第一題自動朗讀
            })();

            // 點擊任意地方 / 按空白鍵 跳下一題
            document.body.addEventListener("click", nextWord);
            document.addEventListener("keydown", e => {
                if (e.code === "Space" || e.code === "Enter") nextWord();
            });
        </script>

    </body>

</html>