<!doctype html>
<html lang="zh-Hant">

    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <link rel="icon" type="image/x-icon" href="rvoca-cart.ico?v=2">

        <title>RVOCA :: CLI Mode</title>
        <style>
            :root {
                --bg: #0d0f12;
                --fg: #e6edf3;
                --dim: #8b949e;
                --kw: #c9d1d9;
                --str: #a5d6ff;
                --op: #ff7b72;
                --num: #79c0ff;
                --cm: #6bc46d;
                --var: #d2a8ff;
                --prop: #e3b341;
                --accent: #2ea043;
                --danger: #f85149;
            }

            html,
            body {
                height: 100%;
                margin: 0;
                background: var(--bg);
                color: var(--fg);
                font-family: "Fira Code", Consolas, "Courier New", monospace;
                font-size: 15px;
                line-height: 1.6
            }

            .wrap {
                max-width: 960px;
                margin: 0 auto;
                padding: 28px
            }

            #boot {
                transition: opacity 1s ease;
            }

            pre {
                margin: 0;
                white-space: pre-wrap;
                word-break: break-word
            }

            .gutter {
                color: #2f343d;
                user-select: none;
                margin-right: 12px
            }

            .cm {
                color: var(--cm)
            }

            .kw {
                color: var(--kw);
                font-weight: 600
            }

            .str {
                color: var(--str)
            }

            .num {
                color: var(--num)
            }

            .op {
                color: var(--op)
            }

            .var {
                color: var(--var)
            }

            .prop {
                color: var(--prop)
            }

            .muted {
                color: var(--dim)
            }

            .status {
                margin-top: 14px;
                color: var(--dim)
            }

            .cursor {
                display: inline-block;
                width: 7px;
                background: #2f81f7;
                animation: blink 1s steps(1) infinite;
                vertical-align: baseline
            }

            @keyframes blink {
                50% {
                    opacity: 0
                }
            }

            /* mobile admin buttons (only visible in admin mode) */
            .fab {
                position: fixed;
                right: 14px;
                bottom: 14px;
                display: none;
                flex-direction: column;
                gap: 10px;
            }

            .fab button {
                border: 1px solid rgba(255, 255, 255, .12);
                background: #161b22;
                color: #ddd;
                padding: 10px 14px;
                border-radius: 10px;
                font-family: inherit;
                font-size: 14px;
                box-shadow: 0 6px 18px rgba(0, 0, 0, .4);
                backdrop-filter: blur(4px);
            }

            .fab .known {
                border-color: rgba(46, 160, 67, .5);
                color: #cfead6
            }

            .fab .wrong {
                border-color: rgba(248, 81, 73, .5);
                color: #ffd4d1
            }

            .fab.show {
                display: flex;
            }

            .badge {
                display: none;
                position: fixed;
                top: 10px;
                right: 12px;
                color: #8cffb7;
                font-size: 12px
            }

            .badge.show {
                display: block;
            }
        </style>
    </head>

    <body>
        <!-- 開機畫面 -->
        <div id="boot" style="
  position:fixed; inset:0;
  background:#000; color:#0f0;
  font-family:'Fira Code',Consolas,monospace;
  display:flex; flex-direction:column;
  justify-content:center; align-items:center;
  font-size:14px; letter-spacing:1px;
  z-index:9999;
">
            <div id="bootText" style="white-space:pre-line; text-align:left;"></div>
        </div>

        <div class="wrap">
            <pre id="code" aria-live="polite"></pre>
            <div class="status" id="status">Space/Enter:reveal → next | K=known（delete）</div>
        </div>

        <!-- mobile admin buttons -->
        <div class="fab" id="fab">
            <button class="known" id="btnKnown">Known ✓</button>
        </div>
        <div class="badge" id="adminBadge">ADMIN</div>

        <script>
            // === 開機動畫 ===
            async function bootSequence() {
                const lines = [
                    "> SYSTEM BOOTING...",
                    "> Loading vocab cartridges [■■■■■■■■■■■■]",
                    "> Initializing audio modules...",
                    "> Syncing data with RVOCA cloud...",
                    "> RVOCA READY."
                ];
                const el = document.getElementById("bootText");
                for (let i = 0; i < lines.length; i++) {
                    el.textContent += (lines[i] + "\n");
                    await new Promise(r => setTimeout(r, 600 + Math.random() * 400));
                }
                await new Promise(r => setTimeout(r, 400));
                document.getElementById("boot").style.opacity = "0";
                document.getElementById("boot").style.transition = "opacity 1s ease";
                setTimeout(() => document.getElementById("boot").remove(), 1000);
            }

            /* === your GAS endpoint === */
            const API_BASE = "https://script.google.com/macros/s/AKfycbyOv4GDW2Ns8pYfUDm1bKEPoTbYxPTS3VC8HdwLTLF8KyOpDEgqhS-XgIZ_ppDJGKo/exec";
            const TOKEN = "rvo-2025-chiuchiou";

            /* config */
            const ROUND_SIZE = 15;
            const LONGPRESS_MS = 800; // 長按 0.8s 啟用 Admin Mode
            const ADMIN_KEY_NAME = 'rvoca_adminKey'; // localStorage key

            let batch = [], ix = -1, revealed = false, remaining = 0, roundId = 0, templateIdx = 0;
            let adminMode = false;

            /* JSONP */
            function jsonp(params) {
                return new Promise((resolve, reject) => {
                    const cb = "cb_" + Math.random().toString(36).slice(2);
                    const qs = new URLSearchParams({ token: TOKEN, callback: cb, ...params });
                    const s = document.createElement("script");
                    s.src = API_BASE + "?" + qs.toString();
                    s.onerror = () => reject(new Error("JSONP error"));
                    window[cb] = (data) => { resolve(data); s.remove(); delete window[cb]; };
                    document.body.appendChild(s);
                    setTimeout(() => reject(new Error("timeout")), 15000);
                });
            }

            /* speech */
            function speak(t) {
                if (!("speechSynthesis" in window)) return;
                speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(t);
                u.lang = "en-US"; u.rate = 0.95;
                speechSynthesis.speak(u);
            }

            /* html escape */
            const esc = s => String(s).replace(/[&<>]/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;' }[m]));

            /* ---------- Code templates (rotate every round) ---------- */
            const TEMPLATES = [
                ({ word, zh, showZh, q, total, remain, seed }) => [
                    `<span class="cm">// rvoca@${seed} – runtime bootstrap</span>`,
                    `<span class="kw">import</span> <span class="var">{ jsonp, speak }</span> <span class="kw">from</span> <span class="str">'rvoca/runtime'</span>`,
                    `<span class="kw">const</span> <span class="var">ROUND_SIZE</span> <span class="op">=</span> <span class="num">${ROUND_SIZE}</span>`,
                    `<span class="kw">let</span> <span class="var">batch</span><span class="op">:</span><span class="var">any[]</span> <span class="op">=</span> []<span class="op">,</span> <span class="var">ix</span><span class="op">=</span><span class="num">0</span>`,
                    ``,
                    `<span class="kw">async function</span> <span class="var">main</span>(){`,
                    `  <span class="kw">const</span> <span class="var">res</span> <span class="op">=</span> <span class="kw">await</span> <span class="var">jsonp</span>({ <span class="prop">action</span><span class="op">:</span> <span class="str">"nextBatch"</span>, <span class="prop">count</span><span class="op">:</span> <span class="var">ROUND_SIZE</span> })`,
                    `  <span class="var">batch</span> <span class="op">=</span> <span class="var">res</span>.<span class="prop">items</span> <span class="op">||</span> []`,
                    `  <span class="kw">const</span> <span class="var">progress</span> <span class="op">=</span> <span class="str">"${q}/${total}"</span> <span class="cm">// progress</span>`,
                    `  <span class="var">document</span>.<span class="prop">title</span> <span class="op">=</span> <span class="str">"rvoca@${seed}"</span>`,
                    ``,
                    `  <span class="var">document</span>.<span class="prop">getElementById</span>(<span class="str">"total"</span>) <span class="op">??=</span> <span class="kw">null</span>`,
                    `  <span class="var">document</span>.<span class="prop">body</span>.<span class="prop">dataset</span>.<span class="prop">w</span> <span class="op">=</span> <span class="str">"${esc(word)}"</span>${showZh ? ` <span class="cm">// '${esc(zh)}'</span>` : ``}`,
                    `  <span class="var">console</span>.<span class="prop">debug</span>(<span class="str">"remaining"</span><span class="op">,</span> <span class="num">${remain}</span>)`,
                    ``,
                    `  <span class="kw">try</span> {`,
                    `    <span class="var">speak</span>(<span class="var">batch</span>[<span class="var">ix</span>].<span class="prop">word</span>)`,
                    `  } <span class="kw">catch</span> (<span class="var">e</span>) {`,
                    `    <span class="var">console</span>.<span class="prop">warn</span>(<span class="str">"tts failed"</span>)`,
                    `  }`,
                    `}`,
                    ``,
                    `<span class="var">main</span>()`,
                    `<span class="cm">// remain:</span> <span class="num">${remain}</span> <span class="cm">// progress:</span> <span class="num">${q}</span><span class="op">/</span><span class="num">${total}</span>`,
                    `<span class="cm">// press Space to reveal, then next</span><span class="cursor"></span>`
                ],
                ({ word, zh, showZh, q, total, remain, seed }) => [
                    `<span class="cm"># rvoca/${seed} – inference session</span>`,
                    `<span class="kw">from</span> rvoca <span class="kw">import</span> jsonp, tts`,
                    `<span class="var">ROUND_SIZE</span> <span class="op">=</span> <span class="num">${ROUND_SIZE}</span>`,
                    ``,
                    `<span class="kw">def</span> <span class="var">load</span>():`,
                    `    <span class="var">res</span> <span class="op">=</span> <span class="var">jsonp</span>({<span class="str">'action'</span><span class="op">:</span><span class="str">'nextBatch'</span>, <span class="str">'count'</span><span class="op">:</span><span class="var">ROUND_SIZE</span>})`,
                    `    <span class="kw">return</span> <span class="var">res</span>.<span class="prop">items</span> <span class="kw">or</span> []`,
                    ``,
                    `<span class="var">batch</span> <span class="op">=</span> <span class="var">load</span>()`,
                    `<span class="var">ix</span> <span class="op">=</span> <span class="num">0</span>`,
                    `<span class="cm"># embed word in a bogus assignment</span>`,
                    `<span class="var">token</span> <span class="op">=</span> <span class="str">"${esc(word)}"</span>${showZh ? ` <span class="cm"># '${esc(zh)}'</span>` : ``}`,
                    ``,
                    `<span class="kw">try</span>:`,
                    `    <span class="var">tts</span>(<span class="var">batch</span>[<span class="var">ix</span>].<span class="prop">word</span>)`,
                    `<span class="kw">except</span> <span class="var">Exception</span> <span class="kw">as</span> <span class="var">e</span>:`,
                    `    <span class="kw">pass</span>`,
                    ``,
                    `<span class="cm"># remaining</span> <span class="num">${remain}</span>`,
                    `<span class="cm"># progress ${q}/${total}</span><span class="cursor"></span>`,
                    ``,
                    `<span class="cm"># EOF</span>`
                ],
                ({ word, zh, showZh, q, total, remain, seed }) => [
                    `<span class="cm"># rvoca build ${seed}</span>`,
                    `<span class="var">ROUND_SIZE</span><span class="op">=</span><span class="num">${ROUND_SIZE}</span>`,
                    `set -e`,
                    ``,
                    `res=$(<span class="var">jsonp</span> <span class="str">action=nextBatch</span> <span class="str">count=${ROUND_SIZE}</span>)`,
                    `items=$(echo $res | jq <span class="str">'.items'</span>)`,
                    ``,
                    `export WORD=<span class="str">"${esc(word)}"</span>${showZh ? ` <span class="cm"># '${esc(zh)}'</span>` : ``}`,
                    `echo <span class="str">"remaining ${remain}"</span>`,
                    ``,
                    `ix=0`,
                    `speak $(jq -r <span class="str">'.[0].word'</span> <<< $items)`,
                    ``,
                    `<span class="cm"># progress ${q}/${total}</span><span class="cursor"></span>`,
                    `exit 0`
                ]
            ];

            /* build code lines with line numbers */
            function buildCode(word, zh, showZh, q, total, remain) {
                const seed = (++roundId).toString(36).slice(-4);
                const lines = TEMPLATES[templateIdx]({ word, zh, showZh, q, total, remain, seed });
                const start = Math.floor(Math.random() * 20) + 1;
                const L = n => String(n).padStart(2, ' ');
                return lines.map((t, i) => `<span class="gutter">${L(start + i)}</span>${t}`).join('\n');
            }

            /* UI */
            function render() {
                const code = document.getElementById('code');
                if (ix < 0 || ix >= batch.length) {
                    code.innerHTML = buildCode("RVOCA.reload()", "新回合", false, 0, ROUND_SIZE, remaining);
                    return;
                }
                const q = ix + 1;
                const { word, zh } = batch[ix];
                code.innerHTML = buildCode(word, zh || "（未填中文）", revealed, q, ROUND_SIZE, remaining);
            }

            /* flow */
            async function startRound() {
                // 每回合切換模板
                templateIdx = (templateIdx + 1) % TEMPLATES.length;

                const res = await jsonp({ action: "nextBatch", count: ROUND_SIZE });
                batch = res.items || [];
                remaining = typeof res.remaining === 'number' ? res.remaining : 0;
                ix = 0; revealed = false;
                render();
                if (batch.length) speak(batch[ix].word);
            }

            function advance() {
                if (!batch.length) { startRound(); return; }
                if (!revealed) {
                    revealed = true; // 第一下 → 顯示中文註解
                    render();
                } else {
                    ix++; revealed = false; // 第二下 → 下一題並朗讀
                    if (ix >= batch.length) {
                        startRound();
                        return;
                    }
                    render();
                    speak(batch[ix].word);
                }
            }

            /* mobile: long-press to enable admin */
            let pressTimer = null;
            document.addEventListener('touchstart', () => { pressTimer = setTimeout(() => { ensureAdmin(); }, LONGPRESS_MS); }, { passive: true });
            document.addEventListener('touchend', () => { clearTimeout(pressTimer); });
            document.addEventListener('mousedown', (e) => { // 桌面也可長按
                pressTimer = setTimeout(() => { ensureAdmin(); }, LONGPRESS_MS);
            });
            document.addEventListener('mouseup', () => { clearTimeout(pressTimer); });

            /* events */
            document.addEventListener('keydown', e => {
                if (e.code === 'Space' || e.code === 'Enter') { e.preventDefault(); advance(); }
                else if (e.key === 'k' || e.key === 'K') { markKnown(); }
            });
            document.body.addEventListener('click', advance);

            /* mobile fab buttons */
            document.getElementById('btnKnown').addEventListener('click', markKnown);

            /* kick off */
            (async () => {
                await bootSequence();   // 先跑開機動畫
                await startRound();     // 再載入第一輪題目
            })();


            // 取得/清除 Admin Key
            function getAdminKey() { return localStorage.getItem(ADMIN_KEY_NAME) || ''; }
            function resetAdmin(silent = false) {
                localStorage.removeItem(ADMIN_KEY_NAME);
                disableAdmin();
                if (!silent) alert('Admin PIN 已清除，請重新輸入');
            }

            // 啟用 Admin（長按觸發時呼叫）
            function ensureAdmin() {
                let k = getAdminKey();
                if (!k) {
                    k = prompt('輸入管理 PIN：'); // 要與 GAS 的 ADMIN_KEY 一致
                    if (!k) return false;
                    localStorage.setItem(ADMIN_KEY_NAME, k);
                }
                adminMode = true;
                document.getElementById('fab')?.classList.add('show');
                document.getElementById('adminBadge')?.classList.add('show');
                return true;
            }

            function disableAdmin() {
                adminMode = false;
                document.getElementById('fab')?.classList.remove('show');
                document.getElementById('adminBadge')?.classList.remove('show');
            }

            // ✅ 改良版：遇到 No permission 自動重驗證
            async function markKnown() {
                if (ix < 0 || ix >= batch.length) return;
                if (!adminMode && !ensureAdmin()) return;

                const key = getAdminKey();
                const res = await jsonp({ action: 'markKnown', id: batch[ix].id, adminKey: key });

                if (!res?.ok && /permission/i.test(res?.error || '')) {
                    // key 錯誤：清除 → 提示 → 重新輸入 → 再試一次（若成功）
                    resetAdmin(true);
                    alert('Admin PIN 驗證失敗，請重新輸入');
                    if (ensureAdmin()) return markKnown();
                    return;
                }

                if (res?.ok) {
                    remaining = (typeof res.remaining === 'number') ? res.remaining : Math.max(0, remaining - 1);
                    advance();
                }
            }

            // ✅ 提供一個鍵盤重置（桌面按 R 可清掉 adminKey）
            document.addEventListener('keydown', e => {
                if (e.key === 'r' || e.key === 'R') {
                    resetAdmin();
                }
            });
        </script>
    </body>

</html>