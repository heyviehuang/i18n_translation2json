<!doctype html>
<html lang="zh-Hant">

    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>RVOCA â€” ä½èª¿ç·´å–®å­—</title>
        <style>
            :root {
                --bg: #0f1115;
                --fg: #e8e8ea;
                --muted: #9aa0a6;
                --accent: #6aa9ff
            }

            html,
            body {
                height: 100%;
                margin: 0;
                background: var(--bg);
                color: var(--fg);
                font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif
            }

            .wrap {
                max-width: 720px;
                margin: 0 auto;
                padding: 24px
            }

            h1 {
                margin: 0 0 12px;
                font-size: 20px;
                color: var(--muted);
                font-weight: 600
            }

            .panel {
                background: #151922;
                border: 1px solid #1d2330;
                border-radius: 16px;
                padding: 20px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, .35)
            }

            .stats {
                display: flex;
                gap: 12px;
                flex-wrap: wrap;
                font-size: 14px;
                color: var(--muted);
                margin-bottom: 16px
            }

            .word {
                user-select: none;
                text-align: center;
                font-size: 48px;
                font-weight: 800;
                letter-spacing: .5px;
                margin: 32px 0 8px;
                cursor: pointer
            }

            .zh {
                text-align: center;
                font-size: 22px;
                color: #cfd3da;
                min-height: 32px;
                opacity: .95
            }

            .controls {
                display: flex;
                gap: 12px;
                justify-content: center;
                margin-top: 24px;
                flex-wrap: wrap
            }

            button {
                background: #1e2431;
                color: var(--fg);
                border: 1px solid #2a3244;
                border-radius: 12px;
                padding: 12px 16px;
                font-size: 16px;
                cursor: pointer;
                transition: transform .06s ease, background .2s ease, border .2s ease
            }

            button:hover {
                transform: translateY(-1px)
            }

            button.destructive {
                background: #3a2025;
                border-color: #5a2a33
            }

            .muted {
                color: var(--muted)
            }

            .progress {
                height: 10px;
                background: #1b2030;
                border-radius: 999px;
                overflow: hidden;
                margin-top: 8px;
                border: 1px solid #242c3e
            }

            .progress>i {
                display: block;
                height: 100%;
                width: 0%;
                background: linear-gradient(90deg, #5fa8ff, #9b7bff)
            }

            .foot {
                margin-top: 24px;
                font-size: 13px;
                color: var(--muted);
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 8px;
                flex-wrap: wrap
            }

            .small {
                font-size: 12px
            }
        </style>
    </head>

    <body>
        <div class="wrap">
            <h1>RVOCA â€” åªé¡¯ç¤ºè‹±æ–‡ï¼Œé»ä¸€ä¸‹æ‰çœ‹ä¸­æ–‡</h1>

            <div class="panel">
                <div class="stats">
                    <div>æœ¬å›åˆï¼š<span id="roundPos">0</span>/<span id="roundTotal">15</span></div>
                    <div>å‰©é¤˜ç¸½å­—æ•¸ï¼š<span id="remaining">â€”</span></div>
                    <div class="small">ï¼ˆé»è‹±æ–‡é¡¯ç¤ºä¸­æ–‡ï¼›åˆ‡ä¸‹ä¸€é¡Œè‡ªå‹•æœ—è®€ï¼‰</div>
                </div>

                <div class="progress"><i id="bar"></i></div>

                <div id="word" class="word">æº–å‚™ä¸­â€¦</div>
                <div id="zh" class="zh muted">ï¼ˆé»ä¸Šæ–¹è‹±æ–‡é¡¯ç¤ºä¸­æ–‡ï¼‰</div>

                <div class="controls">
                    <button id="btnReveal">é¡¯ç¤º / éš±è— ä¸­æ–‡</button>
                    <button id="btnSpeak">å†å¿µä¸€æ¬¡</button>
                    <button id="btnWrong">ä¸ç†Ÿï¼šä¸‹ä¸€å€‹</button>
                    <button id="btnKnown" class="destructive">è¨˜ç†Ÿï¼šåˆªé™¤ä¸¦ä¸‹ä¸€å€‹</button>
                </div>

                <div class="foot">
                    <div>èªéŸ³ï¼š<select id="voiceSelect"></select></div>
                    <div class="muted small">è‹¥æœªå‡ºè²ï¼Œå…ˆé»ä¸€å€‹æŒ‰éˆ•å•Ÿå‹•éŸ³è¨Šæ¬Šé™ã€‚</div>
                </div>
            </div>
        </div>

        <script>
            /* === ä¾ä½ ç’°å¢ƒä¿®æ”¹é€™å…©å€‹å¸¸æ•¸ === */
            const API_BASE = 'https://script.google.com/macros/s/AKfycbyZ83PSWFhIEljAScXy3jTOsS2t1FYwK9V6UlNIwNHRs4j7TjfiBwMyk9f5-ir_tjww/exec';
            const TOKEN = 'rvo-2025-chiuchiou';

            /* === ç‹€æ…‹ === */
            const ROUND_SIZE = 15;
            let batch = [];
            let ix = -1;
            let revealed = false;
            let remainingTotal = 0;

            // èªéŸ³
            let voices = [], chosenVoice = null;
            function loadVoices() {
                voices = window.speechSynthesis.getVoices();
                const sel = document.getElementById('voiceSelect');
                sel.innerHTML = '';
                const preferred = voices.sort((a, b) => {
                    const as = /en/i.test(a.lang) ? 0 : 1;
                    const bs = /en/i.test(b.lang) ? 0 : 1;
                    return as - bs || a.name.localeCompare(b.name);
                });
                preferred.forEach((v, i) => {
                    const opt = document.createElement('option');
                    opt.value = String(i);
                    opt.textContent = `${v.name} (${v.lang})`;
                    sel.appendChild(opt);
                });
                chosenVoice = preferred[0] || null;
                sel.onchange = () => { chosenVoice = preferred[Number(sel.value)] || null; };
            }
            if ('speechSynthesis' in window) {
                speechSynthesis.onvoiceschanged = loadVoices;
                setTimeout(loadVoices, 400);
            }

            /* === API å°å¹«æ‰‹ === */
            async function apiGet(params) {
                const qs = new URLSearchParams({ token: TOKEN, ...params });
                const r = await fetch(`${API_BASE}?${qs.toString()}`, { method: 'GET' });
                return r.json();
            }
            async function apiPost(payload) {
                // ä½¿ç”¨ text/plain é¿å… CORS é æª¢
                const r = await fetch(API_BASE + `?token=${encodeURIComponent(TOKEN)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                return r.json();
            }

            /* === ä¸»æµç¨‹ === */
            async function startRound() {
                const res = await apiGet({ action: 'nextBatch', count: ROUND_SIZE });
                if (!res.ok) return showError(res.error || 'API å¤±æ•—');
                batch = res.items || [];
                remainingTotal = res.remaining ?? 0;
                ix = -1;
                document.getElementById('roundTotal').textContent = String(batch.length);
                next();
            }

            function showError(msg) {
                document.getElementById('word').textContent = 'âš  ' + msg;
                document.getElementById('zh').textContent = '';
            }

            function render() {
                const wordEl = document.getElementById('word');
                const zhEl = document.getElementById('zh');
                const bar = document.getElementById('bar');

                if (ix < 0 || ix >= batch.length) {
                    wordEl.textContent = 'æœ¬å›åˆå®Œæˆ ğŸ‰';
                    zhEl.textContent = '';
                    bar.style.width = '100%';
                    document.getElementById('roundPos').textContent = String(batch.length);
                    return;
                }
                const item = batch[ix];
                wordEl.textContent = item.word;
                zhEl.textContent = revealed ? (item.zh || 'ï¼ˆæœªå¡«ä¸­æ–‡ï¼‰') : 'ï¼ˆé»ä¸Šæ–¹è‹±æ–‡é¡¯ç¤ºä¸­æ–‡ï¼‰';
                zhEl.classList.toggle('muted', !revealed);

                document.getElementById('roundPos').textContent = String(ix + 1);
                document.getElementById('remaining').textContent = String(remainingTotal);
                bar.style.width = (ix / Math.max(1, batch.length)) * 100 + '%';
            }

            function speak(text) {
                if (!('speechSynthesis' in window)) return;
                speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                if (chosenVoice) u.voice = chosenVoice;
                u.lang = (chosenVoice && chosenVoice.lang) || 'en-US';
                u.rate = 1.0; u.pitch = 1.0;
                speechSynthesis.speak(u);
            }

            function next(autoSpeak = true) {
                ix++; revealed = false;
                render();
                if (ix >= 0 && ix < batch.length && autoSpeak) speak(batch[ix].word);
            }

            /* === äº‹ä»¶ === */
            document.getElementById('word').addEventListener('click', () => { revealed = !revealed; render(); });
            document.getElementById('btnReveal').addEventListener('click', () => { revealed = !revealed; render(); });
            document.getElementById('btnSpeak').addEventListener('click', () => { if (ix >= 0 && ix < batch.length) speak(batch[ix].word); });
            document.getElementById('btnWrong').addEventListener('click', async () => {
                if (ix < 0 || ix >= batch.length) return;
                const cur = batch[ix];
                apiPost({ action: 'markwrong', id: cur.id }).catch(() => { });
                next(true);
            });
            document.getElementById('btnKnown').addEventListener('click', async () => {
                if (ix < 0 || ix >= batch.length) return;
                const cur = batch[ix];
                const res = await apiPost({ action: 'markknown', ids: [cur.id] });
                if (res && res.ok && typeof res.remaining === 'number') remainingTotal = res.remaining;
                next(true);
            });

            /* èµ·è·‘ */
            startRound();
        </script>
    </body>

</html>